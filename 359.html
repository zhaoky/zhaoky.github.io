<!DOCTYPE html><html lang="zh-CN"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#3eaf7c">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/apple-touch-icon.png" color="#3eaf7c">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.flqin.com","root":"/","images":"/images","scheme":"Pisces","version":"8.0.2","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="javascript 从诞生之日起就是一门单线程的非阻塞的脚本语言。而非阻塞则是当代码需要进行一项异步任务（无法立刻返回结果，需要花一定时间才能返回的任务，如 I/O 事件）的时候，主线程会挂起（pending）这个任务，然后在异步任务返回结果的时候再根据一定规则去执行相应的回调。到底是如何实现非阻塞这一点呢？答案就是 事件循环(Event Loop)。 当函数被调用时，会被添加到 调用栈 栈中的">
<meta property="og:type" content="article">
<meta property="og:title" content="事件循环(Event Loop)">
<meta property="og:url" content="https://blog.flqin.com/359.html">
<meta property="og:site_name" content="前端轻语">
<meta property="og:description" content="javascript 从诞生之日起就是一门单线程的非阻塞的脚本语言。而非阻塞则是当代码需要进行一项异步任务（无法立刻返回结果，需要花一定时间才能返回的任务，如 I/O 事件）的时候，主线程会挂起（pending）这个任务，然后在异步任务返回结果的时候再根据一定规则去执行相应的回调。到底是如何实现非阻塞这一点呢？答案就是 事件循环(Event Loop)。 当函数被调用时，会被添加到 调用栈 栈中的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cdn.flqin.com/p359-1.png">
<meta property="og:image" content="http://cdn.flqin.com/p359-2.png">
<meta property="og:image" content="http://cdn.flqin.com/p359-4.png">
<meta property="og:image" content="http://cdn.flqin.com/p359-3.png">
<meta property="article:published_time" content="2019-07-10T10:03:10.000Z">
<meta property="article:modified_time" content="2019-07-10T10:03:10.000Z">
<meta property="article:author" content="Korey">
<meta property="article:tag" content="前端,前端开发,css,html,js,css3,前端开发博客,fe,技术文档">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cdn.flqin.com/p359-1.png">


<link rel="canonical" href="https://blog.flqin.com/359.html">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>事件循环(Event Loop) | 前端轻语</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c8dec20f0d0449c8ece3c0dbab4e8f31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">前端轻语</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">korey的前端笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">97</span></a>

  </li>
        <li class="menu-item menu-item-map">

    <a href="/map/" rel="section"><i class="fa fa-sitemap fa-fw"></i>map</a>

  </li>
        <li class="menu-item menu-item-link">

    <a href="/link/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>link</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97"><span class="nav-number">1.</span> <span class="nav-text">任务队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-number">2.</span> <span class="nav-text">浏览器中的事件循环</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%82%B9"><span class="nav-number">2.2.</span> <span class="nav-text">相关点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#await"><span class="nav-number">2.2.1.</span> <span class="nav-text">await</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#update-rendering%EF%BC%88%E8%A7%86%E5%9B%BE%E6%B8%B2%E6%9F%93%EF%BC%89"><span class="nav-number">2.2.2.</span> <span class="nav-text">update rendering（视图渲染）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#life-of-a-frame"><span class="nav-number">2.2.3.</span> <span class="nav-text">life of a frame</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#requestAnimationFrame-amp-requestIdleCallback"><span class="nav-number">2.2.4.</span> <span class="nav-text">requestAnimationFrame &amp; requestIdleCallback</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%BE%8B"><span class="nav-number">2.3.</span> <span class="nav-text">举例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">例 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B-2"><span class="nav-number">2.3.2.</span> <span class="nav-text">例 2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B-3"><span class="nav-number">2.3.3.</span> <span class="nav-text">例 3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B-4"><span class="nav-number">2.3.4.</span> <span class="nav-text">例 4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B-5"><span class="nav-number">2.3.5.</span> <span class="nav-text">例 5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B-6"><span class="nav-number">2.3.6.</span> <span class="nav-text">例 6</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NODE-%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF-%E9%80%82%E7%94%A8%E4%BA%8E-NODE-11-%E4%BB%A5%E4%B8%8B"><span class="nav-number">3.</span> <span class="nav-text">NODE 中的事件循环(适用于 NODE 11 以下)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%A8%A1%E5%9E%8B"><span class="nav-number">3.1.</span> <span class="nav-text">事件循环模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#poll"><span class="nav-number">3.1.1.</span> <span class="nav-text">poll</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#node-%E5%86%85%E7%BD%AE%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">node 内置定时器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-number">3.2.</span> <span class="nav-text">node 注意点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-%E4%B8%BE%E4%BE%8B"><span class="nav-number">3.3.</span> <span class="nav-text">node 举例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-11-%E7%89%88%E6%9C%AC%E5%90%8E"><span class="nav-number">3.4.</span> <span class="nav-text">node 11 版本后</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%A4%E8%80%85%E5%BE%AA%E7%8E%AF%E5%8C%BA%E5%88%AB-NODE-11-%E4%B9%8B%E5%89%8D"><span class="nav-number">4.</span> <span class="nav-text">两者循环区别(NODE 11 之前)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.</span> <span class="nav-text">其他</span></a></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Korey" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Korey</p>
  <div class="site-description" itemprop="description">热衷于记录、分享前端开发技术</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">97</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poYW9reQ==" title="GitHub → https://github.com/zhaoky"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmtleXUuemhhb0Bmb3htYWlsLmNvbQ==" title="E-Mail → mailto:keyu.zhao@foxmail.com"><i class="far fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vdXNlci81N2M5MWIzYjE2NWFiZDAwNjhkYjg5YzI=" title="掘金 → https://juejin.im/user/57c91b3b165abd0068db89c2"><i class="fas fa-link fa-fw"></i>掘金</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cDovL3d3dy56aGlodS5jb20vcGVvcGxlL2ZlX2tvcmV5" title="知乎 → http://www.zhihu.com/people/fe_korey"><i class="fas fa-link fa-fw"></i>知乎</span>
      </span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poYW9reQ==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.flqin.com/359.html">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Korey">
      <meta itemprop="description" content="热衷于记录、分享前端开发技术">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前端轻语">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          事件循环(Event Loop)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-07-10 10:03:10" itemprop="dateCreated datePublished" datetime="2019-07-10T10:03:10+00:00">2019-07-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Basics/" itemprop="url" rel="index"><span itemprop="name">Computer Basics</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 ≈</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><code>javascript</code> 从诞生之日起就是一门单线程的非阻塞的脚本语言。而非阻塞则是当代码需要进行一项异步任务（无法立刻返回结果，需要花一定时间才能返回的任务，如 <code>I/O</code> 事件）的时候，主线程会挂起（<code>pending</code>）这个任务，然后在异步任务返回结果的时候再根据一定规则去执行相应的回调。到底是如何实现非阻塞这一点呢？答案就是 <code>事件循环(Event Loop)</code>。</p>
<p>当函数被调用时，会被添加到 <code>调用栈</code> 栈中的顶部，执行完成之后就从栈顶部移出该函数，直到栈内被清空。每次栈内被清空都会去读取 <code>任务队列</code> 有没有任务，有就按照顺序读取执行。如果这个时候栈中又出现了事件，该事件又去调用了 <code>WebAPIs</code> 里的异步方法，那这些异步方法会在再被调用的时候放在 <code>任务队列</code> 里，一直循环读取-执行的操作，就形成了 <code>事件循环</code>。</p>
<p><code>调用栈</code> 是一种 <code>后进先出（LIFO）</code> 的数据结构，<code>任务队列</code> 是 <code>先进先出（FIFO）</code> 的数据结构。</p>
<h2 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h2><p>事件循环是通过 <code>任务队列（task queue）</code> 的机制来进行协调的。一个事件循环中，可以有一个或者多个任务队列，一个任务队列便是一系列有序任务 <code>task</code> 的集合，每个任务都有一个任务源 <code>task source</code>，源自同一个任务源的 <code>task</code> 必须放到同一个任务队列，从不同源来的则被添加到不同队列。</p>
<p><code>JavaScript</code> 单线程中的任务分为 <code>同步任务</code> 和 <code>异步任务</code>。同步任务会在 <code>调用栈\执行栈（call stack）</code> 中按照顺序排队等待<code>主线程</code>执行，异步任务则会在异步有了结果后将注册的回调函数添加到 <code>任务队列(消息队列)</code> 中等待主线程空闲（即栈内被清空）的时候读取到栈中等待主线程执行。</p>
<p>异步任务队列可分为 <code>task(macrotask)</code> 宏任务队列和 <code>microtask(job)</code> 微任务队列两类，不同的 <code>API</code> 注册的异步任务会依次进入自身对应的队列中，然后等待 <code>Event Loop</code> 将它们依次压入执行栈中执行，宏任务队列可以有多个，微任务队列只有一个。</p>
<ul>
<li>宏任务主要包含：<code>script(整体代码)</code>、<code>setTimeout</code>、<code>setInterval</code>、<code>I/O</code>、<code>UI交互事件</code>、<code>postMessage</code>、<code>MessageChannel</code>、<code>setImmediate(Node.js 环境)</code>、<code>requestAnimationFrame</code></li>
<li>微任务主要包含：<code>Promise的方法及其派生</code>、<code>MutationObserver（浏览器）</code>、<code>Object.observe(已废弃)</code><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1b2t1bmluZy9ibG9ncy9pc3N1ZXMvMQ==">查阅<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h2 id="浏览器中的事件循环"><a href="#浏览器中的事件循环" class="headerlink" title="浏览器中的事件循环"></a>浏览器中的事件循环</h2><p><img data-src="http://cdn.flqin.com/p359-1.png" alt="总体图"></p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>在事件循环中，每进行一次循环操作称为 <code>tick</code>，每一次 <code>tick</code> 的任务处理模型是比较复杂的，但关键步骤如下：</p>
<ul>
<li>在此次 <code>tick</code> 中选择最先进入队列的任务(<code>oldest task</code>)，如果有则执行(一个)，如果执行中有异步任务就放至各自的队列中</li>
<li>检查是否存在 <code>Microtasks</code>，如果存在则<strong>不停地执行</strong>，直至清空 <code>Microtasks Queue</code></li>
<li>更新 <code>render(update rendering)</code>（GUI 线程）</li>
<li>取出下一个宏任务 <code>task</code>，主线程重复执行上述步骤（回到 JS 线程）</li>
</ul>
<p><img data-src="http://cdn.flqin.com/p359-2.png" alt="示意图"></p>
<h3 id="相关点"><a href="#相关点" class="headerlink" title="相关点"></a>相关点</h3><h4 id="await"><a href="#await" class="headerlink" title="await"></a>await</h4><p><code>await</code> 将直接使用 <code>Promise.resolve()</code> 相同语义<span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzI2ODAwNzk2OS9hbnN3ZXIvMzM5ODExOTk4">查阅<i class="fa fa-external-link-alt"></i></span>，即：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 end'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">//等价于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">Promise</span>.resolve(async2()).then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'async1 end'</span>);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"><span class="comment">//等价于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">    resolve(async2());</span><br><span class="line">  }).then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'async1 end'</span>);</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="update-rendering（视图渲染）"><a href="#update-rendering（视图渲染）" class="headerlink" title="update rendering（视图渲染）"></a>update rendering（视图渲染）</h4><p><code>update rendering（视图渲染）</code>发生在本轮事件循环的 <code>microtask</code> 队列被执行完之后，也就是说执行任务的耗时会影响视图渲染的时机。通常浏览器以每秒 60 帧（<code>60fps</code>）的速率刷新页面，这个帧率最适合人眼交互，大概 <code>16.7ms</code> 渲染一帧，所以如果要让用户觉得顺畅，单个 <code>macrotask</code> 及它相关的所有 <code>microtask</code> 最好能在 <code>16.7ms</code> 内完成。</p>
<p>也不是每轮事件循环都会执行 <code>update rendering</code>，浏览器有自己的优化策略，可能把几次的视图更新累积到一起重绘。重绘之前会通知 <code>requestAnimationFrame</code> 执行回调函数，即<code>requestAnimationFrame</code> 的执行时机是在一次或多次事件循环的 <code>UI render</code> 阶段。<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vc3Vuc2hxL3AvNTgwNzU3NS5odG1s">查阅 1<i class="fa fa-external-link-alt"></i></span>,<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Zod2ZyMnUwMnEvYXJ0aWNsZS9kZXRhaWxzLzc5NDkyMzAz">查阅 2<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="life-of-a-frame"><a href="#life-of-a-frame" class="headerlink" title="life of a frame"></a>life of a frame</h4><p>浏览器页面是一帧一帧绘制出来的，每一帧（<code>Frame</code>）都需要完成哪些工作？</p>
<ol>
<li><strong>Input event</strong>：处理用户的交互，如点击、触碰、滚动等事件</li>
<li><strong>JS</strong>：<code>JS</code> 解析执行（可能有多个事件循环）</li>
<li><strong>Begin frame</strong>：帧开始。窗口尺寸变更，页面滚动等的处理</li>
<li><strong>rAf</strong>：<code>requestAnimationFrame</code></li>
<li><strong>Layout</strong>：布局</li>
<li><strong>Paint</strong>： 绘制</li>
</ol>
<p><img data-src="http://cdn.flqin.com/p359-4.png" alt="life of a frame"></p>
<p>上面六个步骤完成后没超过 16 ms，说明时间有富余，此时就会执行 <code>requestIdleCallback</code> 里注册的任务。</p>
<h4 id="requestAnimationFrame-amp-requestIdleCallback"><a href="#requestAnimationFrame-amp-requestIdleCallback" class="headerlink" title="requestAnimationFrame &amp; requestIdleCallback"></a>requestAnimationFrame &amp; requestIdleCallback</h4><ul>
<li><p><code>requestAnimationFrame</code>: 告诉浏览器在下次重绘之前执行传入的回调函数(通常是用于操纵 <code>dom</code>，更新动画的函数)；由于是每帧执行一次，那结果就是每秒的执行次数与浏览器屏幕刷新次数一样，通常是每秒 60 次。</p>
</li>
<li><p><code>requestIdleCallback</code>: 会在浏览器空闲时间执行回调，也就是允许开发人员在主事件循环中执行低优先级任务，而不影响一些延迟关键事件。如果有多个回调，会按照先进先出原则执行；但是当传入了 <code>timeout</code>，为了避免超时，有可能会打乱这个顺序；由于它发生在一帧的最后，此时页面布局已经完成，所以不建议在 <code>requestIdleCallback</code> 里再操作 <code>DOM</code>，这样会导致页面再次重绘。</p>
</li>
</ul>
<blockquote>
<p><code>Promise</code> 不建议在这里面进行，因为 <code>Promise</code> 的回调属性 <code>Event loop</code> 中优先级较高的一种微任务，会在 <code>requestIdleCallback</code> 结束时立即执行，不管此时是否还有富余的时间，这样有很大可能会让一帧超过 16 ms。</p>
</blockquote>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个sleep函数，模拟阻塞</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">d</span>) </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> t = <span class="built_in">Date</span>.now(); <span class="built_in">Date</span>.now() - t &lt;= d;);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callself</span>(<span class="params"></span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(++count, <span class="string">'frame'</span>)</span><br><span class="line">    sleep(<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">if</span>(count&lt;<span class="number">20</span>){</span><br><span class="line">        <span class="built_in">window</span>.requestAnimationFrame(callself);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 当count&lt;20时候，就一直使用raf占满16ms，这样模拟一帧中无空闲时间</span></span><br><span class="line"><span class="built_in">window</span>.requestAnimationFrame(callself);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cb1</span>(<span class="params">{didTimeout}</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'idle cb1'</span>, didTimeout)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cb2</span>(<span class="params">{didTimeout}</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'idle cb2'</span>, didTimeout)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cb3</span>(<span class="params">{didTimeout}</span>)</span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'idle cb3'</span>, didTimeout)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册三个rIC回调，正常是按照先进先出原则执行这三个回调，当设置的有timeout，该回调会被提前</span></span><br><span class="line"><span class="built_in">window</span>.requestIdleCallback(cb1)</span><br><span class="line"><span class="built_in">window</span>.requestIdleCallback(cb2)</span><br><span class="line"><span class="built_in">window</span>.requestIdleCallback(cb3, {</span><br><span class="line">    timeout: <span class="number">30</span></span><br><span class="line">})</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><h4 id="例-1"><a href="#例-1" class="headerlink" title="例 1"></a>例 1</h4><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span> <span class="title">promise1</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">});</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">setTimeout1</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setTimeout1'</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span> <span class="title">promise2</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</span><br><span class="line">  });</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">setTimeout2</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setTimeout2'</span>);</span><br><span class="line">}, <span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="例-2"><a href="#例-2" class="headerlink" title="例 2"></a>例 2</h4><p>解析<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2R3cXMvYmxvZy9pc3N1ZXMvNjE=">查阅<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">  resolve(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="number">2</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">}).then(<span class="function">(<span class="params">t</span>) =&gt;</span> <span class="built_in">console</span>.log(t));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="例-3"><a href="#例-3" class="headerlink" title="例 3"></a>例 3</h4><p>解析<span class="exturl" data-url="aHR0cHM6Ly9zZWdtZW50ZmF1bHQuY29tL3EvMTAxMDAwMDAxNzgwMTMyNA==">查阅<i class="fa fa-external-link-alt"></i></span> <span class="exturl" data-url="aHR0cHM6Ly9lczYucnVhbnlpZmVuZy5jb20vI2RvY3MvcHJvbWlzZSNQcm9taXNlLXJlc29sdmU=">参照<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">  resolve(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve({</span><br><span class="line">    then: <span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>{</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">      resolve(<span class="number">3</span>);</span><br><span class="line">    },</span><br><span class="line">  }).then(<span class="function">(<span class="params">t</span>) =&gt;</span> <span class="built_in">console</span>.log(t));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">}).then(<span class="function">(<span class="params">t</span>) =&gt;</span> <span class="built_in">console</span>.log(t));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">5</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="例-4"><a href="#例-4" class="headerlink" title="例 4"></a>例 4</h4><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 start'</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 end'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async2'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script start'</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setTimeout'</span>);</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line">async1();</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">  resolve();</span><br><span class="line">})</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</span><br><span class="line">  })</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise3'</span>);</span><br><span class="line">  });</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script end'</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="例-5"><a href="#例-5" class="headerlink" title="例 5"></a>例 5</h4><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> intervalA = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'intervalA'</span>);</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timeout'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">clearInterval</span>(intervalA);</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> intervalB = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'intervalB'</span>);</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> intervalC = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'intervalC'</span>);</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; ++i) {</span><br><span class="line">    i === <span class="number">9999</span> &amp;&amp; resolve();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise after for-loop'</span>);</span><br><span class="line">})</span><br><span class="line">  .then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">  })</span><br><span class="line">  .then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">clearInterval</span>(intervalB);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise in timeout'</span>);</span><br><span class="line">    resolve();</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise after timeout'</span>);</span><br><span class="line">})</span><br><span class="line">  .then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise4'</span>);</span><br><span class="line">  })</span><br><span class="line">  .then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise5'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">clearInterval</span>(intervalC);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise3'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="例-6"><a href="#例-6" class="headerlink" title="例 6"></a>例 6</h4><p>解析<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NjA2ODE3MQ==">查阅<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(<span class="string">'start'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'timeout1'</span>);</span></span><br><span class="line">  }, 0);</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">Promise</span>.resolve().then(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span></span><br><span class="line">  });</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'timeout2'</span>);</span></span><br><span class="line">  }, 0);</span><br><span class="line"></span><br><span class="line"><span class="javascript">  requestAnimationFrame(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'requestAnimationFrame'</span>);</span></span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">Promise</span>.resolve().then(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</span></span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(<span class="string">'end'</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 输出：start promise1 end promise2 requestAnimationFrame timeout1 timeout2  --&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="NODE-中的事件循环-适用于-NODE-11-以下"><a href="#NODE-中的事件循环-适用于-NODE-11-以下" class="headerlink" title="NODE 中的事件循环(适用于 NODE 11 以下)"></a>NODE 中的事件循环(适用于 NODE 11 以下)</h2><p><code>Node.js</code> 采用 <code>V8</code> 作为 <code>js</code> 的解析引擎，而事件循环方面使用了自己设计的 <code>libuv</code>。<code>Node.js</code> 的事件循环核心对应 <code>libuv</code> 中的 <a target="_blank" rel="noopener" href="https://github.com/libuv/libuv/blob/v1.35.0/src/unix/core.c#L365-L400"><code>uv_run</code> 函数</a>，整个事件循环迭代就是一个 <code>while</code> 无限循环。</p>
<blockquote>
<p>libuv 是使用 C 语言实现的单线程非阻塞异步 I/O 解决方案，本质上它是对常见操作系统底层异步 I/O 操作的封装，并对外暴露功能一致的 API， 首要目的是尽可能的为 nodejs 在不同系统平台上提供统一的事件循环模型。</p>
</blockquote>
<h3 id="事件循环模型"><a href="#事件循环模型" class="headerlink" title="事件循环模型"></a>事件循环模型</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   ┌───────────────────────┐</span><br><span class="line">┌─&gt;│        timers         │ 执行到期的 `setTimeout` 和 `setInterval` 回调</span><br><span class="line">│  └──────────┬────────────┘</span><br><span class="line">│  ┌──────────┴────────────┐</span><br><span class="line">│  │     I/O callbacks     │ 执行到期的一些被延迟调用的 `I/O` 回调</span><br><span class="line">│  └──────────┬────────────┘</span><br><span class="line">│  ┌──────────┴────────────┐</span><br><span class="line">│  │     idle, prepare     │ 仅 `node` 内部使用</span><br><span class="line">│  └──────────┬────────────┘      ┌───────────────┐</span><br><span class="line">│  ┌──────────┴────────────┐      │   incoming:   │</span><br><span class="line">│  │         poll          │&lt;──connections───     │ 立即执行大部分 `I/O` 回调</span><br><span class="line">│  └──────────┬────────────┘      │   data, etc.  │</span><br><span class="line">│  ┌──────────┴────────────┐      └───────────────┘</span><br><span class="line">│  │        check          │ 执行到期的 `setImmediate` 的回调</span><br><span class="line">│  └──────────┬────────────┘</span><br><span class="line">│  ┌──────────┴────────────┐</span><br><span class="line">└──┤    close callbacks    │ 执行注册 `close` 事件的回调，如 `socket` 等</span><br><span class="line">   └───────────────────────┘</span><br></pre></td></tr></tbody></table></figure>

<p>其中外部输入数据则从 <code>poll</code> 阶段开始。</p>
<ul>
<li><code>event loop</code> 总是要经历以上阶段，由 <code>timer</code> 阶段开始，由 <code>close</code> 回调函数阶段结束。</li>
<li><code>event loop</code> 的每个阶段都有一个任务队列。</li>
<li><code>event loop</code> 到达某个阶段时，将执行该阶段的任务队列，该任务队列完成后执行 <code>nextTick队列</code>，然后执行 <code>微任务队列</code>。直到队列清空或执行的回调达到系统上限后，才会转入下一个阶段。</li>
<li>当所有阶段被顺序执行一次后，称 <code>event loop</code> 完成了一个 <code>tick</code>。</li>
</ul>
<p><img data-src="http://cdn.flqin.com/p359-3.png" alt="示意图"></p>
<h4 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h4><p><code>poll</code> 是一个至关重要的阶段，会做两件事情：</p>
<ul>
<li>计算当前轮询需要阻塞后续阶段（即维持）的时间：由<strong>后续 tick 各个阶段是否存在不为空的回调函数队列</strong> 和 <strong>最近的计时器时间节点</strong> 决定。若所有队列为空且不存在任何计时器，那么事件循环将 <strong>无限制地维持在 poll 阶段</strong>。其中<ul>
<li>对于事件循环部分属性而言:<ul>
<li><code>uv_stop()</code> 函数标记为停止时，不阻塞；</li>
<li>不处于活动状态时且不存在活动的 <code>request</code> 时，不阻塞；</li>
<li><code>idle</code> 句柄队列不为空时，不阻塞；</li>
<li><code>I/O callbacks</code> 回调队列不为空时，不阻塞；</li>
<li><code>closing</code> 句柄不为空时，不阻塞；</li>
</ul>
</li>
<li>对于计时器而言：<ul>
<li>若不存在任何计时器（<code>setTimeout/setInterval</code>），那么当前事件循环中的 <code>poll</code> 阶段将<strong>一直阻塞</strong></li>
<li>若最近计时器时间节点&lt;=开始时间，则表明在<code>计时器二叉最小</code>堆中<strong>至少存在一个</strong>过期的计时器，那么当前 <code>poll</code> 阶段的超时时间将被设置为 0 即不阻塞。这是为了尽可能快的进入下一阶段，即尽可能快地结束当前事件循环。</li>
<li>若最近计时器时间节点&gt;开始时间，<code>poll</code> 将根据此差值来阻塞当前阶段，阻塞是为了保持在该阶段从而尽可能快的处理异步 I/O 事件。</li>
</ul>
</li>
</ul>
</li>
<li>处理 <code>poll</code> 队列的事件回调（<strong>事件循环 tick 总有一种维持 poll 状态的倾向</strong>，为了尽可能快的处理随时可能到来异步 <code>I/O</code> 事件）</li>
</ul>
<p>如果 <code>poll</code> 阶段进入 <code>idle</code> 状态并且存在 <code>setImmediate</code>，那么 <code>poll</code> 阶段将打破无限制的等待状态，并进入 <code>check</code> 阶段执行 <code>setImmediate</code>。</p>
<blockquote>
<p>poll 阶段控制了计时器回调函数的执行时机：在没有满足 poll 阶段的结束条件时，就无法进入到下一个事件循环 tick 的 timer 阶段，就无法执行 timer queue 中到期计时器的回调函数。<br>因为 poll 阶段的超时时间在进入 poll 阶段之前计算，故当前 poll 阶段中回调函数队列中的计时器并不影响当前 poll 阶段的超时时间。</p>
</blockquote>
<h4 id="node-内置定时器"><a href="#node-内置定时器" class="headerlink" title="node 内置定时器"></a>node 内置定时器</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="comment">//一些代码;</span></span><br><span class="line">}, timeout);</span><br></pre></td></tr></tbody></table></figure>

<p><code>nodejs</code> 中所有计时器是通过一个<code>双向链表</code>实现关联。有且仅有两种计时器：<code>setTimeout/setInterval</code> 和 <code>setImmediate</code>。同浏览器一致，所有的计时器实现都不能保证在到达时间阈值后回调函数一定会被立即执行，它们只能保证在到达时间阈值后，尽快执行由计时器注册的回调函数。</p>
<p>所有计时器在 <code>libuv</code> 中是以计时器回调函数的执行时间节点（即 <code>time + timeout</code>，而不是<code>计时器时间阈值（上述代码里的timeout）</code>）构成的<code>二叉最小堆</code>结构来存储。通过<code>二叉最小堆</code>的根节点来获取时间线上最近的 <code>timer</code> 对应的回调函数的句柄，再通过该句柄对应的 <code>timeout</code> 值获取最近的计时器的执行时间节点。</p>
<p>时间阈值 <code>timeout</code> 的取值范围是 <code>1 ~ 231-1 ms</code>，且为整数。所有超出时间阈值范围的时间阈值都会被重置为 <code>1ms</code>，且所有非整数值会被转换为 <code>整数值</code>。即 <code>setTimeout(callback, 0)</code> 会自动转为 <code>setTimeout(callback, 1)</code>。</p>
<h3 id="node-注意点"><a href="#node-注意点" class="headerlink" title="node 注意点"></a>node 注意点</h3><ul>
<li><code>process.nextTick()</code>: 这个函数其实是独立于 <code>Event Loop</code> 之外的，它有一个自己的队列，当 <code>每个阶段</code> 完成后，如果存在 <code>nextTick 队列</code>，就会清空队列中的所有回调函数，并且 <code>优先于其他 microtask 执行</code>。</li>
<li><code>setTimeout(callback, 0)</code> 和 <code>setImmediate(callback)</code> 的执行顺序是随机的，跟代码执行时间与 <code>1ms</code> 大小比较有关。而上述代码在 <code>I/0 callbacks</code> 阶段调用则执行顺序是 <code>setImmediate</code> <code>在前，setTimeout</code> 在后（第二轮）。</li>
</ul>
<h3 id="node-举例"><a href="#node-举例" class="headerlink" title="node 举例"></a>node 举例</h3><p>根据以上知识点，以下这些例子就很容易理解了：</p>
<p>eg1：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'test.txt'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'readFile'</span>);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timeout'</span>);</span><br><span class="line">  }, <span class="number">0</span>);</span><br><span class="line">  setImmediate(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'immediate'</span>);</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>eg2：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer1'</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">  });</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer2'</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</span><br><span class="line">  });</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise3'</span>);</span><br><span class="line">});</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>eg3：</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer1'</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">  });</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line">process.nextTick(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'nextTick'</span>);</span><br><span class="line">  process.nextTick(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'nextTick'</span>);</span><br><span class="line">    process.nextTick(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'nextTick'</span>);</span><br><span class="line">      process.nextTick(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'nextTick'</span>);</span><br><span class="line">      });</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>eg4:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">time</span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> startTime = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">new</span> <span class="built_in">Date</span>() - startTime &lt; time) {}</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'1s over'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setTimeout - 1'</span>);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout - 1 - 1'</span>);</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout - 1 - then'</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'setTimeout - 1 - then - then'</span>);</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">  sleep(<span class="number">1000</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setTimeout - 2'</span>);</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout - 2 - 1'</span>);</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout - 2 - then'</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'setTimeout - 2 - then - then'</span>);</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">  sleep(<span class="number">1000</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<h3 id="node-11-版本后"><a href="#node-11-版本后" class="headerlink" title="node 11 版本后"></a>node 11 版本后</h3><p><strong>和浏览器趋同，都是每执行一个宏任务就执行完微任务队列</strong>，故上面例子在不同版本表现不一致。<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NDk1MTU1MA==">查阅 1<i class="fa fa-external-link-alt"></i></span>,<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FkdmFuY2VkLUZyb250ZW5kL0RhaWx5LUludGVydmlldy1RdWVzdGlvbi9pc3N1ZXMvMjY=">查阅 2<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="两者循环区别-NODE-11-之前"><a href="#两者循环区别-NODE-11-之前" class="headerlink" title="两者循环区别(NODE 11 之前)"></a>两者循环区别(NODE 11 之前)</h2><ul>
<li>在浏览器中,事件循环是由 <code>macrotask、microtask</code> 组成，执行顺序是 <code>macrotask-&gt;microtask</code>。</li>
<li>在 <code>Node.js</code> 中，事件循环由多个 <code>阶段 phase</code> 的 <code>多个回调函数队列 callbacks queues</code> 组成。在每一个阶段执行顺序是 <code>macrotask-&gt;nextTick-&gt;microtask</code>。</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80ODUyMjI0OQ==">从 Chrome 源码看事件循环<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9zZXQuc2gvcG9zdC8yMDAzMTctaG93LW5vZGVqcy1ldmVudC1sb29wLXdvcmtz">从 libuv 看 nodejs 事件循环<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/356.html" rel="prev" title="（转载）nginx配置location总结及rewrite规则写法">
                  <i class="fa fa-chevron-left"></i> （转载）nginx配置location总结及rewrite规则写法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/358.html" rel="next" title="promise 实现">
                  promise 实现 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  © 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Korey zhao</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">514k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:47</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js"></script>


  
  




  















  








  

  

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script>

<script src="/bundle.js"></script><script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  ;
L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":125,"height":150,"position":"left","hOffset":30,"vOffset":-5},"mobile":{"show":false,"scale":0.05},"react":{"opacityDefault":1,"opacityOnHover":0.2},"log":false});</script></body></html>